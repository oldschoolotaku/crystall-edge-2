/*
 * This file is sublicensed under MIT License
 * https://github.com/space-wizards/space-station-14/blob/master/LICENSE.TXT
 */

using System.Linq;
using Content.Shared._CE.Workbench;
using Content.Shared._CE.Workbench.Prototypes;
using Robust.Client.AutoGenerated;
using Robust.Client.Player;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client._CE.Workbench;

[GenerateTypedNameReferences]
public sealed partial class CEWorkbenchWindow : DefaultWindow
{
    private const int AllCategoryId = -1;

    [Dependency] private readonly IPlayerManager _player = default!;
    [Dependency] private readonly IPrototypeManager _prototype = default!;
    [Dependency] private readonly ILogManager _log = default!;

    public event Action<CEWorkbenchUiRecipesEntry>? OnCraft;

    /// <summary>
    /// Used for category dropdown filtering.
    /// </summary>
    private readonly Dictionary<int, LocId> _categoryIndexes = new();

    private Dictionary<LocId, List<CEWorkbenchUiRecipesEntry>> _categories = new();
    private List<CEWorkbenchUiRecipesEntry> _uncategorized = new();

    private CEWorkbenchUiRecipesState? _cachedState;
    private CEWorkbenchUiRecipesEntry? _selectedEntry;
    private string _searchFilter = string.Empty;

    private ISawmill Sawmill { get; init; }

    public CEWorkbenchWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        Sawmill = _log.GetSawmill("ce_workbench_window");

        SearchBar.OnTextChanged += OnSearchChanged;
        CraftButton.OnPressed += OnCraftPressed;
        OptionCategories.OnItemSelected += OnCategoryItemSelected;
    }

    private void UpdateRecipesVisibility()
    {
        if (_cachedState is null)
            return;

        CraftsContainer.RemoveAllChildren();

        if (_uncategorized.Count > 0 && OptionCategories.SelectedId == AllCategoryId)
        {
            var uncategorizedGridContainer = new GridContainer();
            uncategorizedGridContainer.Columns = 5;
            uncategorizedGridContainer.VerticalExpand = true;

            CraftsContainer.AddChild(uncategorizedGridContainer);
            AddRecipeListToGrid(_uncategorized, uncategorizedGridContainer);
        }

        foreach (var category in _categories)
        {
            if (_categoryIndexes.TryGetValue(OptionCategories.SelectedId, out var selectedCategory) &&
                category.Key != selectedCategory)
                continue;

            var categoryLabel = new RichTextLabel();
            categoryLabel.Margin = new Thickness(5);
            categoryLabel.Text = Loc.GetString(category.Key);
            CraftsContainer.AddChild(categoryLabel);

            var gridContainer = new GridContainer();
            gridContainer.Columns = 5;
            gridContainer.VerticalExpand = true;
            CraftsContainer.AddChild(gridContainer);

            AddRecipeListToGrid(category.Value, gridContainer);
        }

        if (_selectedEntry is not null && !_cachedState.Recipes.Contains(_selectedEntry.Value))
            RecipeSelectNull();
    }

    private void AddRecipeListToGrid(List<CEWorkbenchUiRecipesEntry> category, GridContainer gridContainer)
    {
        foreach (var entry in category)
        {
            if (!_prototype.TryIndex(entry.ProtoId, out var indexedEntry))
            {
                Sawmill.Error($"No recipe prototype {entry.ProtoId} retrieved from cache found");
                continue;
            }

            if (!ProcessSearchFilter(entry, indexedEntry))
                continue;

            if (!ProcessSearchCategoryFilter(indexedEntry))
                continue;

            var control = new CEWorkbenchRecipeControl(entry);
            control.OnSelect += RecipeSelect;

            gridContainer.AddChild(control);
        }
    }

    public void UpdateState(CEWorkbenchUiRecipesState recipesState)
    {
        if (_player.LocalEntity is null)
            return;

        _cachedState = recipesState;

        _categoryIndexes.Clear();
        _categories.Clear();
        _uncategorized.Clear();
        OptionCategories.Clear();
        OptionCategories.AddItem(Loc.GetString("ce-recipe-category-all"), AllCategoryId);

        // First, we sort all the recipes by priority and category.
        var sortedRecipes = recipesState.Recipes
            .OrderByDescending(e => e.Craftable)
            .ThenByDescending(e =>
            {
                if (!_prototype.TryIndex(e.ProtoId, out CEWorkbenchRecipePrototype? recipe))
                    return 0;
                return recipe.Priority;
            })
            .ThenBy(e =>
            {
                if (!_prototype.TryIndex(e.ProtoId, out CEWorkbenchRecipePrototype? recipe) ||
                    !_prototype.TryIndex(recipe.Category, out CEWorkbenchRecipeCategoryPrototype? category))
                    return string.Empty;
                return category.ID;
            });

        foreach (var entry in sortedRecipes)
        {
            if (!_prototype.TryIndex(entry.ProtoId, out var indexedEntry))
                continue;

            if (!_prototype.TryIndex(indexedEntry.Category, out var indexedCategory))
            {
                _uncategorized.Add(entry);
                continue;
            }

            if (!_categories.TryGetValue(indexedCategory.Name, out var entries))
            {
                entries = new List<CEWorkbenchUiRecipesEntry>();
                _categories[indexedCategory.Name] = entries;
            }

            entries.Add(entry);
        }

        // Sort categories by priority
        var sortedCategories = _categories
            .OrderByDescending(c =>
            {
                var categoryProto = _prototype.EnumeratePrototypes<CEWorkbenchRecipeCategoryPrototype>()
                    .FirstOrDefault(p => p.Name == c.Key);
                return categoryProto?.Priority ?? 0;
            })
            .ToList();

        _categories = sortedCategories.ToDictionary(pair => pair.Key, pair => pair.Value);

        var count = 0;
        foreach (var category in _categories)
        {
            OptionCategories.AddItem(Loc.GetString(category.Key), count);
            _categoryIndexes.Add(count, category.Key);
            count++;
        }

        UpdateRecipesVisibility();
    }

    private void OnSearchChanged(LineEdit.LineEditEventArgs _)
    {
        _searchFilter = SearchBar.Text.Trim().ToLowerInvariant();
        UpdateRecipesVisibility();
    }

    private void OnCraftPressed(BaseButton.ButtonEventArgs _)
    {
        if (_selectedEntry is null)
            return;

        OnCraft?.Invoke(_selectedEntry.Value);
    }

    private void OnCategoryItemSelected(OptionButton.ItemSelectedEventArgs obj)
    {
        OptionCategories.SelectId(obj.Id);
        UpdateRecipesVisibility();
    }

    private bool ProcessSearchFilter(CEWorkbenchUiRecipesEntry entry, CEWorkbenchRecipePrototype indexedEntry)
    {
        if (_searchFilter == string.Empty)
            return true;

        // Skip the iteration, because the desired result does not match the filter
        if (_prototype.TryIndex(indexedEntry.Result, out var indexedResult))
            return indexedResult.Name.Contains(_searchFilter);

        Sawmill.Error($"No result entity prototype {entry.ProtoId} retrieved from cache found");
        return false;
    }

    private bool ProcessSearchCategoryFilter(CEWorkbenchRecipePrototype indexedEntry)
    {
        // If we are searching through all categories, we simply skip the current filter
        if (OptionCategories.SelectedId == AllCategoryId)
            return true;

        if (!_categoryIndexes.TryGetValue(OptionCategories.SelectedId, out var selectedCategory))
        {
            Sawmill.Error($"Non-existent {OptionCategories.SelectedId} category id selected. Filter skipped");
            return true;
        }

        if (indexedEntry.Category is null)
            return false;

        if (!_prototype.TryIndex(indexedEntry.Category, out var indexedCategory))
        {
            Sawmill.Error($"Non-existent {indexedEntry.Category} category prototype id. Filter skipped");
            return true;
        }

        return indexedCategory.Name == selectedCategory;
    }

    private void RecipeSelect(CEWorkbenchUiRecipesState recipesState)
    {
        foreach (var entry in recipesState.Recipes)
        {
            RecipeSelect(entry, _prototype.Index(entry.ProtoId));
            break;
        }
    }

    private void RecipeSelect(CEWorkbenchUiRecipesEntry cachedEntry)
    {
        if (_cachedState is null)
            return;

        if (_cachedState.Recipes.Contains(cachedEntry))
        {
            Sawmill.Warning($"The selected cache option {cachedEntry} isn't found in recipes");
            return;
        }

        RecipeSelect(cachedEntry, _prototype.Index(cachedEntry.ProtoId));
    }

    private void RecipeSelect(CEWorkbenchUiRecipesEntry entry, CEWorkbenchRecipePrototype recipe)
    {
        _selectedEntry = entry;

        var result = _prototype.Index(recipe.Result);

        // TODO: Make it through the localization?
        var counter = recipe.ResultCount > 1 ? $" x{recipe.ResultCount}" : string.Empty;

        ItemView.SetPrototype(recipe.Result);
        ItemName.Text = result.Name + counter;
        ItemDescription.Text = result.Description;
        ItemRequirements.RemoveAllChildren();

        foreach (var requirement in recipe.Requirements)
        {
            ItemRequirements.AddChild(new CEWorkbenchRequirementControl(requirement));
        }

        CraftButton.Disabled = !entry.Craftable;
    }

    private void RecipeSelectNull()
    {
        _selectedEntry = null;

        ItemView.SetPrototype(null);
        ItemName.Text = string.Empty;
        ItemDescription.Text = string.Empty;
        ItemRequirements.RemoveAllChildren();
        CraftButton.Disabled = true;
    }
}
